<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Chat en Temps RÃ©el</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>

    <!-- PAGE DE CONNEXION-->
    <div id="loginPage">
        <div id="loginBox">
            <h2>Bienvenue ğŸ‘‹</h2>
            <p>Entrez votre pseudo pour rejoindre le chat</p>

            <input id="loginUsername" type="text" placeholder="Ex : Alice" autocomplete="off">
            <button id="loginBtn">Entrer dans le chat</button>
        </div>
    </div>

    <!-- PAGE DE CHAT-->
    <div id="chatPage" class="hidden">

        <div class="app">
            <header>
                <div class="title">
                    <span class="icon">ğŸ’¬</span>
                    <span class="title-gradient">Chat en Temps RÃ©el</span>
                </div>

                <div class="user-pill">
                    <span class="user-dot"></span>
                    <span id="currentUser">Connexionâ€¦</span>
                    <button id="logoutBtn" class="logout-btn">Se dÃ©connecter</button>
                </div>
            </header>

            <div class="chat-layout">

                <!-- barre  -->
                <aside class="sidebar">
                    <div>
                        <div class="sidebar-title">Utilisateurs en ligne</div>
                        <div id="userList" class="user-list"></div>
                    </div>
                </aside>

                <!--ZONE DE CHAT -->
                <section class="chat-panel">

                    <div id="loading">Chargement des messages...</div>
                    <div id="messages"></div>
                    <div id="typing"></div>

                    <!-- Zone dâ€™Ã©criture -->
                    <div id="inputArea">
                        <div class="input-wrapper">
                            <button id="emojiBtn" class="icon-btn">ğŸ˜Š</button>
                            <button id="imageBtn" class="icon-btn">ğŸ“·</button>

                            <input id="message" type="text" placeholder="Ã‰crivez votre message...">
                            <input type="file" id="imageInput" accept="image/*" hidden>
                        </div>

                        <button id="send">
                            <span>Envoyer</span>
                            <span class="icon">â¤</span>
                        </button>
                    </div>

                    <!-- SÃ©lecteur dâ€™emojis -->
                    <div id="emojiPicker">
                        <span>ğŸ˜€</span><span>ğŸ˜</span><span>ğŸ˜‚</span><span>ğŸ¤£</span><span>ğŸ˜ƒ</span>
                        <span>ğŸ˜„</span><span>ğŸ˜…</span><span>ğŸ˜†</span><span>ğŸ˜‰</span><span>ğŸ˜Š</span>
                        <span>ğŸ˜</span><span>ğŸ¤©</span><span>ğŸ˜˜</span><span>ğŸ˜š</span><span>ğŸ˜œ</span>
                        <span>ğŸ¤ª</span><span>ğŸ˜</span><span>ğŸ˜</span><span>ğŸ˜’</span><span>ğŸ˜</span>
                        <span>ğŸ˜”</span><span>ğŸ˜Ÿ</span><span>ğŸ˜•</span><span>ğŸ™</span><span>â˜¹ï¸</span>
                        <span>ğŸ˜£</span><span>ğŸ˜–</span><span>ğŸ˜«</span><span>ğŸ˜©</span><span>ğŸ¥º</span>
                        <span>ğŸ˜¢</span><span>ğŸ˜­</span><span>ğŸ˜¤</span><span>ğŸ˜ </span><span>ğŸ˜¡</span>
                        <span>ğŸ¤¬</span><span>ğŸ¤¯</span><span>ğŸ˜³</span><span>ğŸ¥µ</span><span>ğŸ¥¶</span>
                        <span>ğŸ˜±</span><span>ğŸ˜¨</span><span>ğŸ˜°</span><span>ğŸ˜¥</span><span>ğŸ˜“</span>
                        <span>ğŸ¤—</span><span>ğŸ¤”</span><span>ğŸ¤¨</span><span>ğŸ˜</span><span>ğŸ˜‘</span>
                        <span>ğŸ˜¶</span><span>ğŸ™„</span><span>ğŸ˜¬</span><span>ğŸ¤¥</span><span>ğŸ˜´</span>
                        <span>ğŸ˜ª</span><span>ğŸ˜µ</span><span>ğŸ¤</span><span>ğŸ¥´</span><span>ğŸ¤¢</span>
                        <span>ğŸ¤®</span><span>ğŸ¤§</span><span>ğŸ˜·</span><span>ğŸ¤’</span><span>ğŸ¤•</span>
                    </div>

                </section>
            </div>
        </div>

    </div>


    <script src="/socket.io/socket.io.js"></script>

    <script>

        /* GESTION DU LOGIN */

        const loginPage = document.getElementById("loginPage");
        const chatPage = document.getElementById("chatPage");
        const loginBtn = document.getElementById("loginBtn");

        loginBtn.onclick = () => {
            const username = document.getElementById("loginUsername").value.trim();
            if (!username) return alert("Pseudo obligatoire");

            localStorage.setItem("username", username);

            loginPage.classList.add("hidden");
            chatPage.classList.remove("hidden");

            startChat(username);
        };


        /* LANCEMENT DU CHAT */
        function startChat(username) {

            const socket = io({ auth: { username } });

            document.getElementById("currentUser").textContent =
                "ConnectÃ© en tant que " + username;

            // RÃ©cupÃ©ration des Ã©lÃ©ments de surface
            const messagesDiv = document.getElementById("messages");
            const typingDiv = document.getElementById("typing");
            const input = document.getElementById("message");
            const btn = document.getElementById("send");
            const logoutBtn = document.getElementById("logoutBtn");
            const userListDiv = document.getElementById("userList");
            const imageBtn = document.getElementById("imageBtn");
            const imageInput = document.getElementById("imageInput");
            const emojiPicker = document.getElementById("emojiPicker");
            const emojiBtn = document.getElementById("emojiBtn");

            /* DÃ©connexion */
            logoutBtn.onclick = function () {
                localStorage.removeItem("username");
                socket.disconnect();
                location.reload();
            };


            /* Format dâ€™heure */
            function formatTime(d) {
                const date = new Date(d);
                return date.getHours().toString().padStart(2, "0") + ":" +
                    date.getMinutes().toString().padStart(2, "0");
            }


            /* Affichage dâ€™un message */
            function renderMessage(msg) {
                const div = document.createElement("div");
                div.classList.add("msg");

                if (msg.username === username)
                    div.classList.add("me");
                else
                    div.classList.add("other");

                let content = `
                    <div class="username">
                        <span>${msg.username}</span>
                        <span class="timestamp">${formatTime(msg.createdAt)}</span>
                    </div>
                `;

                if (msg.text) content += `<div>${msg.text}</div>`;
                if (msg.image) content += `<img src="${msg.image}" />`;

                div.innerHTML = content;
                messagesDiv.appendChild(div);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }


            /* Envoi texte */
            btn.onclick = sendMessage;
            input.onkeypress = (e) => {
                if (e.key === "Enter") sendMessage();
                socket.emit("typing");
            };

            function sendMessage() {
                const text = input.value.trim();
                if (!text) return;
                socket.emit("chat message", { text });
                input.value = "";
            }


            /* Historique */
            socket.on("history", (msgs) => {
                document.getElementById("loading").style.display = "none";
                msgs.forEach(renderMessage);
            });

            socket.on("chat message", renderMessage);
            socket.on("chat image", renderMessage);


            /* Messages systÃ¨me */
            socket.on("server message", (msg) => {
                const div = document.createElement("div");
                div.classList.add("msg", "system");
                div.textContent = msg;
                messagesDiv.appendChild(div);
            });


            /* Liste des utilisateurs */
            socket.on("user list", (list) => {
                userListDiv.innerHTML = list
                    .map(u => `<div class="user-line"><span class="user-dot"></span> ${u}</div>`)
                    .join("");
            });


            /* Indication dâ€™Ã©criture */
            socket.on("typing", (u) => {
                typingDiv.textContent = u + " Ã©crit...";
                setTimeout(() => typingDiv.textContent = "", 800);
            });


            /* Gestion des images */
            imageBtn.onclick = () => imageInput.click();

            imageInput.onchange = () => {
                const file = imageInput.files[0];
                const reader = new FileReader();

                reader.onload = () => {
                    socket.emit("chat image", { image: reader.result });
                };

                reader.readAsDataURL(file);
            };


            /*  GESTION DES EMOJIS */
            emojiBtn.onclick = () => {
                emojiPicker.style.display =
                    emojiPicker.style.display === "flex" ? "none" : "flex";
            };

            emojiPicker.addEventListener("click", (e) => {
                if (e.target.tagName === "SPAN") {
                    input.value += e.target.textContent;
                    input.focus();
                    emojiPicker.style.display = "none";
                }
            });

        }

    </script>

</body>

</html>