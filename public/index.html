<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Chat en Temps RÃ©el</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>

    <div class="app">
        <header>
            <div class="title">
                <span class="icon">ğŸ’¬</span>
                <span class="title-gradient">Chat en Temps RÃ©el</span>
            </div>
            <div class="user-pill">
                <span class="user-dot"></span>
                <span id="currentUser">Connexionâ€¦</span>
            </div>
        </header>

        <div class="chat-layout">
            <aside class="sidebar">
                <div>
                    <div class="sidebar-title">Astuces</div>

                    <div class="tip-line">
                        <span class="tip-icon">â</span>
                        <span>Appuyez sur EntrÃ©e pour envoyer</span>
                    </div>

                    <div class="tip-line">
                        <span class="tip-icon">ğŸ“·</span>
                        <span>Envoyer une image depuis votre appareil</span>
                    </div>

                    <div class="tip-line">
                        <span class="tip-icon">ğŸ˜Š</span>
                        <span>Ajouter un emoji Ã  votre message</span>
                    </div>
                </div>

                <div>
                    <div class="sidebar-title">Raccourcis</div>

                    <div class="pill">
                        <span>â</span> <span>Envoyer</span>
                    </div>
                </div>
            </aside>


            <section class="chat-panel">
                <div id="messages"></div>
                <div id="typing"></div>

                <div id="inputArea">
                    <div class="input-wrapper">
                        <button id="emojiBtn" class="icon-btn" title="Emoji">ğŸ˜Š</button>
                        <button id="imageBtn" class="icon-btn" title="Envoyer une image">ğŸ“·</button>
                        <input id="message" type="text" placeholder="Ã‰crivez votre message..." autocomplete="off" />
                        <input type="file" id="imageInput" accept="image/*" style="display:none">
                    </div>
                    <button id="send">
                        <span>Envoyer</span>
                        <span class="icon">â¤</span>
                    </button>
                </div>

                <div id="emojiPicker">
                    <span>ğŸ˜€</span><span>ğŸ˜</span><span>ğŸ˜‚</span><span>ğŸ¤£</span><span>ğŸ˜Š</span><span>ğŸ˜</span>
                    <span>ğŸ˜</span><span>ğŸ˜¢</span><span>ğŸ˜­</span><span>ğŸ˜¡</span><span>ğŸ˜±</span><span>ğŸ¤¯</span>
                    <span>ğŸ‘</span><span>ğŸ‘</span><span>ğŸ™</span><span>ğŸ”¥</span><span>ğŸ‰</span><span>â­</span>
                    <span>ğŸ’¡</span><span>âœ…</span><span>âŒ</span><span>â¤ï¸</span><span>ğŸ’”</span><span>âš½</span>
                    <span>ğŸ±</span><span>ğŸ¶</span><span>ğŸŒ™</span><span>â˜€ï¸</span><span>ğŸŒˆ</span>
                </div>
            </section>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const username = prompt("Entrez votre nom d'utilisateur :") || "Anonyme";
        socket.emit('user joined', username);

        const messagesDiv = document.getElementById('messages');
        const typingDiv = document.getElementById('typing');
        const input = document.getElementById('message');
        const btn = document.getElementById('send');
        const currentUserSpan = document.getElementById('currentUser');

        const emojiBtn = document.getElementById("emojiBtn");
        const emojiPicker = document.getElementById("emojiPicker");
        const imageBtn = document.getElementById("imageBtn");
        const imageInput = document.getElementById("imageInput");

        currentUserSpan.textContent = `ConnectÃ© en tant que ${username}`;

        function formatTime(dateString) {
            const d = dateString ? new Date(dateString) : new Date();
            const h = String(d.getHours()).padStart(2, "0");
            const m = String(d.getMinutes()).padStart(2, "0");
            return `${h}:${m}`;
        }

        function renderMessage(data, type = "normal") {
            const div = document.createElement("div");

            if (type === "system") {
                div.classList.add("msg", "system");
                div.textContent = data;
            } else {
                div.classList.add("msg");
                if (data.username === username) {
                    div.classList.add("me");
                } else {
                    div.classList.add("other");
                }

                const time = formatTime(data.createdAt);
                let html = `
                <div class="username">
                    <span>${data.username}</span>
                    <span class="timestamp">${time}</span>
                </div>
            `;

                if (data.text) {
                    html += `<div>${data.text}</div>`;
                }
                if (data.image) {
                    html += `<img src="${data.image}" alt="image">`;
                }

                div.innerHTML = html;
            }

            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Envoi message texte
        function sendMessage() {
            const msg = input.value.trim();
            if (msg !== "") {
                const payload = { username, text: msg };
                socket.emit("chat message", payload);
                input.value = "";
            }
        }

        btn.onclick = sendMessage;

        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
            socket.emit('typing', username);
        });

        // Historique
        socket.on("history", (messages) => {
            messages.forEach(msg => {
                renderMessage(msg);
            });
        });

        // Message texte reÃ§u
        socket.on("chat message", (data) => {
            renderMessage(data);
        });

        // Message systÃ¨me
        socket.on("server message", (msg) => {
            renderMessage(msg, "system");
        });

        // Indicateur dâ€™Ã©criture
        socket.on("typing", (user) => {
            if (!user) return;
            typingDiv.textContent = `${user} est en train d'Ã©crire...`;
            setTimeout(() => {
                typingDiv.textContent = "";
            }, 1000);
        });

        // Gestion des images
        imageBtn.onclick = () => imageInput.click();

        imageInput.onchange = () => {
            const file = imageInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
                const base64Image = reader.result;
                socket.emit("chat image", {
                    username,
                    image: base64Image
                });
            };
            reader.readAsDataURL(file);
        };

        socket.on("chat image", (data) => {
            renderMessage(data);
        });

        // Emoji picker
        emojiBtn.onclick = () => {
            emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
            emojiPicker.style.flexWrap = "wrap";
        };

        emojiPicker.addEventListener("click", (e) => {
            if (e.target.tagName === "SPAN") {
                input.value += e.target.textContent;
                input.focus();
                emojiPicker.style.display = "none";
            }
        });

        // Fermer l'emoji picker si on clique en dehors
        document.addEventListener("click", (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.style.display = "none";
            }
        });
    </script>

</body>

</html>